# alerting/rules.yml
groups:
- name: svg-ai-alerts
  rules:
  - alert: HighResponseTime
    expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 5
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "High response time detected"
      description: "95th percentile response time is {{ $value }}s for the last 5 minutes"

  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "High error rate detected"
      description: "Error rate is {{ $value | humanizePercentage }} for the last 5 minutes"

  - alert: HighMemoryUsage
    expr: container_memory_usage_bytes{name="svg-ai"} > 500000000
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High memory usage detected"
      description: "Memory usage is {{ $value | humanizeBytes }} (>500MB) for container {{ $labels.name }}"

  - alert: ServiceDown
    expr: up{job="svg-ai"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "SVG-AI service is down"
      description: "SVG-AI service has been down for more than 1 minute"

  - alert: RedisDown
    expr: up{job="redis"} == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Redis service is down"
      description: "Redis service has been down for more than 1 minute"

  - alert: HighCPUUsage
    expr: rate(container_cpu_usage_seconds_total{name="svg-ai"}[5m]) * 100 > 80
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High CPU usage detected"
      description: "CPU usage is {{ $value }}% for container {{ $labels.name }}"

  - alert: DiskSpaceLow
    expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 < 10
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Low disk space"
      description: "Disk space is {{ $value }}% available on {{ $labels.device }}"

  - alert: TooManyConnections
    expr: redis_connected_clients > 100
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Too many Redis connections"
      description: "Redis has {{ $value }} connections (>100)"

  - alert: QueueBacklog
    expr: http_requests_active > 50
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "Request queue backlog"
      description: "{{ $value }} active requests in queue (>50)"

- name: svg-ai-performance
  rules:
  - alert: SlowConversionTime
    expr: avg_over_time(conversion_duration_seconds[10m]) > 10
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Slow conversion performance"
      description: "Average conversion time is {{ $value }}s over the last 10 minutes"

  - alert: LowQualityResults
    expr: avg_over_time(conversion_quality_ssim[10m]) < 0.7
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "Low quality conversion results"
      description: "Average SSIM quality is {{ $value }} over the last 10 minutes"

  - alert: CacheHitRateLow
    expr: rate(cache_hits_total[5m]) / rate(cache_requests_total[5m]) < 0.5
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: "Low cache hit rate"
      description: "Cache hit rate is {{ $value | humanizePercentage }} over the last 5 minutes"