name: Security Scan

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements/dev.txt

    - name: Run pip-audit security scan
      run: |
        pip-audit --format=json --output=audit-results.json
        pip-audit --format=markdown --output=audit-results.md

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-scan-results
        path: |
          audit-results.json
          audit-results.md

    - name: Check for high-severity vulnerabilities
      run: |
        # Exit with error if high-severity vulnerabilities are found
        # This will fail the CI build for critical security issues
        if pip-audit --format=json | jq -e '.vulnerabilities[] | select(.severity == "high" or .severity == "critical")' > /dev/null; then
          echo "::error::High or critical severity vulnerabilities found!"
          echo "Please review and update the affected packages."
          exit 1
        else
          echo "No high or critical severity vulnerabilities found."
        fi

    - name: Comment security scan results on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('audit-results.md')) {
            const auditResults = fs.readFileSync('audit-results.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ”’ Security Scan Results\n\n${auditResults}`
            });
          }

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC